#include <CUnit/CUnit.h>
#include "ndnld.h"

void test_PartialMsgs_single(void) {
	PartialMsgs target = PartialMsgs_ctor();
	DataPkt pkt0 = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x01\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\xAA\xC5\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCD\x00\x00", 39, true));
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt0), PartialMsgRes_deliver);
	CcnbMsg msg = PartialMsgs_getDeliver(target);
	CU_ASSERT_PTR_NOT_NULL(msg);
	CU_ASSERT_EQUAL(CcnbMsg_getSize(msg), 8);
	CU_ASSERT_NSTRING_EQUAL(CcnbMsg_getBody(msg), "\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCD", 8);
	CcnbMsg_dtor(msg);
	PartialMsgs_dtor(target);
}

void test_PartialMsgs_fails(void) {
	PartialMsgs target = PartialMsgs_ctor();
	DataPkt pkt0 = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x01\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\0\x00\x4E\x64\x4C\xA2\x95\0\x03\x00\x4E\x64\x4C\xAA\xC5\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCD\x00\x00", 55, true));
	DataPkt pkt0ml = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x01\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\0\x00\x4E\x64\x4C\xA2\x95\0\x03\x00\x4E\x64\x4C\xAA\xCD\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCD\xE0\x00\x00", 56, true));
	DataPkt pkt0mc = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x01\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\0\x00\x4E\x64\x4C\xA2\x95\0\x04\x00\x4E\x64\x4C\xAA\xC5\xCC\xCC\xCC\xCC\xCC\xCC\xE0\xCD\x00\x00", 55, true));
	DataPkt pkt1 = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x02\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\x01\x00\x4E\x64\x4C\xA2\x95\0\x03\x00\x4E\x64\x4C\xAA\xC5\xAA\xAA\xAA\xAA\xAA\xAA\xAA\xAB\x00\x00", 55, true));
	DataPkt pkt1d = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x02\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\x01\x00\x4E\x64\x4C\xA2\x95\0\x03\x00\x4E\x64\x4C\xAA\xC5\xBB\xBB\xBB\xBB\xBB\xBB\xBB\xBC\x00\x00", 55, true));
	DataPkt pkt2 = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x03\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\x02\x00\x4E\x64\x4C\xA2\x95\0\x03\x00\x4E\x64\x4C\xAA\xA5\xEE\xEE\xEE\xEF\x00\x00", 51, true));
	DataPkt pkt3o = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x04\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\x03\x00\x4E\x64\x4C\xA2\x95\0\x03\x00\x4E\x64\x4C\xAA\xC5\xDD\xDD\xDD\xDD\xDD\xDD\xDD\xDE\x00\x00", 55, true));
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt1), PartialMsgRes_stored);
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt0ml), PartialMsgRes_mismatch);
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt0mc), PartialMsgRes_mismatch);
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt0), PartialMsgRes_stored);
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt1d), PartialMsgRes_duplicate);
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt3o), PartialMsgRes_outRange);
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt2), PartialMsgRes_deliver);
	CcnbMsg msg = PartialMsgs_getDeliver(target);
	CU_ASSERT_PTR_NOT_NULL(msg);
	CU_ASSERT_EQUAL(CcnbMsg_getSize(msg), 20);
	CU_ASSERT_NSTRING_EQUAL(CcnbMsg_getBody(msg), "\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCD\xAA\xAA\xAA\xAA\xAA\xAA\xAA\xAB\xEE\xEE\xEE\xEF", 20);
	CcnbMsg_dtor(msg);
	NdnlpPkt_dtor(pkt0ml);
	NdnlpPkt_dtor(pkt0mc);
	NdnlpPkt_dtor(pkt1d);
	PartialMsgs_dtor(target);
}

void test_PartialMsgs_small_inOrder(void) {
	DataPkt pkt0 = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x01\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\0\x00\x4E\x64\x4C\xA2\x95\0\x03\x00\x4E\x64\x4C\xAA\xC5\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCD\x00\x00", 55, true));
	DataPkt pkt1 = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x02\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\x01\x00\x4E\x64\x4C\xA2\x95\0\x03\x00\x4E\x64\x4C\xAA\xC5\xAA\xAA\xAA\xAA\xAA\xAA\xAA\xAB\x00\x00", 55, true));
	DataPkt pkt2 = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x03\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\x02\x00\x4E\x64\x4C\xA2\x95\0\x03\x00\x4E\x64\x4C\xAA\xA5\xEE\xEE\xEE\xEF\x00\x00", 51, true));

	PartialMsgs target = PartialMsgs_ctor();
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt0), PartialMsgRes_stored);
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt1), PartialMsgRes_stored);
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt2), PartialMsgRes_deliver);
	CcnbMsg msg = PartialMsgs_getDeliver(target);
	CU_ASSERT_PTR_NOT_NULL(msg);
	CU_ASSERT_EQUAL(CcnbMsg_getSize(msg), 20);
	CU_ASSERT_NSTRING_EQUAL(CcnbMsg_getBody(msg), "\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCD\xAA\xAA\xAA\xAA\xAA\xAA\xAA\xAB\xEE\xEE\xEE\xEF", 20);
	CcnbMsg_dtor(msg);
	PartialMsgs_dtor(target);
}

void test_PartialMsgs_small_outOfOrder(void) {
	DataPkt pkt0 = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x01\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\0\x00\x4E\x64\x4C\xA2\x95\0\x03\x00\x4E\x64\x4C\xAA\xC5\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCD\x00\x00", 55, true));
	DataPkt pkt1 = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x02\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\x01\x00\x4E\x64\x4C\xA2\x95\0\x03\x00\x4E\x64\x4C\xAA\xC5\xAA\xAA\xAA\xAA\xAA\xAA\xAA\xAB\x00\x00", 55, true));
	DataPkt pkt2 = NdnlpPkt_asData(NdnlpPkt_ctor("\x4E\x64\x4C\x82\x4E\x64\x4C\x8A\xB5\0\0\0\0\x20\x03\x00\x4E\x64\x4C\x92\x95\0\0\x00\x4E\x64\x4C\x9A\x95\0\x02\x00\x4E\x64\x4C\xA2\x95\0\x03\x00\x4E\x64\x4C\xAA\xA5\xEE\xEE\xEE\xEF\x00\x00", 51, true));

	PartialMsgs target = PartialMsgs_ctor();
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt2), PartialMsgRes_stored);
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt1), PartialMsgRes_stored);
	CU_ASSERT_EQUAL(PartialMsgs_arrive(target, pkt0), PartialMsgRes_deliver);
	CcnbMsg msg = PartialMsgs_getDeliver(target);
	CU_ASSERT_PTR_NOT_NULL(msg);
	CU_ASSERT_EQUAL(CcnbMsg_getSize(msg), 20);
	CU_ASSERT_NSTRING_EQUAL(CcnbMsg_getBody(msg), "\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCD\xAA\xAA\xAA\xAA\xAA\xAA\xAA\xAB\xEE\xEE\xEE\xEF", 20);
	CcnbMsg_dtor(msg);
	PartialMsgs_dtor(target);
}

void suite_PartialMsg(void) {
	CU_pSuite suite = CU_add_suite("PartialMsg", NULL, NULL);
	CU_add_test(suite, "PartialMsgs_single", test_PartialMsgs_single);
	CU_add_test(suite, "PartialMsgs_fails", test_PartialMsgs_fails);
	CU_add_test(suite, "PartialMsgs_small_inOrder", test_PartialMsgs_small_inOrder);
	CU_add_test(suite, "PartialMsgs_small_outOfOrder", test_PartialMsgs_small_outOfOrder);
	//CU_add_test(suite, "PartialMsgs_large", test_PartialMsgs_large);
}

